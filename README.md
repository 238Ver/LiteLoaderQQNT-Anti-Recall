# LiteLoaderQQNT - anti-recall

LiteLoaderQQNT插件，用于比较完善的防撤回。
使用前需要安装[LiteLoaderQQNT](https://github.com/mo-jinran/LiteLoaderQQNT)，并在QQNT新版上使用。

## 使用方法

建议前往release中下载压缩包，保留文件夹结构（文件夹名称为`插件名`，内容为github上的内容），将文件夹移动至`LiteLoaderQQNT数据目录/plugins/`下面，重启QQNT即可。

直接克隆源码的话，需要手动进行`npm install`。

所有被撤回的消息会被带上红框，文字加上删除线。**重新进消息界面仍然可以看到。**当前版本重启QQ后**只能恢复文字和表情消息**，图片消息暂不可用，请等待版本更新。



现在，即使图片在撤回之前未打开过，撤回后也能继续查看了，并且不止缩略图，点开看也是可以的！

但是如果不是在眼前撤回的，而是撤回后你才点进聊天界面去看的，图片仍然会转圈一段时间（请耐心等待），猜测因为QQ会先检查图片是否存在，撤回后还没下载当然不存在，所以转圈；等插件下载好图片后，需要等待QQ重新检查，才能显示图片。

图片如果撤回太快，反撤回后有可能会一直加载不出来，这个可能是图片已经从服务器上删除了，这种情况下，**无法恢复**。



## 原理介绍

**之前版本（过时）：** 为什么在简介里说是简易的呢？因为这个防撤回原理是通过拦截撤回消息的IPC，这样消息就不会被删除。可是，若重新打开消息界面，NTQQ似乎会重新向逻辑层拉取一次消息（旧版QQ的防撤回直接从通信上就拦截了撤回包，所以没有这个问题；而本插件仅拦截到了渲染层的IPC，逻辑层还是一个黑盒），所以导致消息仍然被撤回了。

**现在版本的变更：** 在接到消息后会将消息存于内存中，进入消息界面后，若发现撤回会拦截撤回包，并显示红色边框以及给文字附加删除线。若重新进入消息页面，会遍历消息列表，若发现撤回的提示，会寻找之前保存过的消息，若找到，则将撤回提示替换为之前保存的消息，并显示红色边框以及给文字附加删除线；若未找到，则仍然显示撤回提示。这样，重进消息界面**仍然可以正确反撤回**（包括打开独立聊天界面**也可以**）。

- 为避免太占内存，保存消息的上限默认为1000条。如有需要，可自行修改`main.js`中的`MAX_MSG_SAVED_LIMIT`常量。这个值的意义是，假设默认最多存1000条，那么总接到消息的1000条之前的消息若被撤回则无法恢复。**不过，若一条消息在撤回后你回去看了，并且反撤回生效（也就是只要你看到了这条消息出现红框和删除线），则这条消息会被额外储存到专门的“已撤回消息数组”中，这个数组没有容量上限，不会被本限制所约束。**
- 为避免可能存在的并发问题，消息超过上述限制后，每次接到消息后默认会删除保存的消息列表中的前50条，直到低于上述上限。这个50条你也可以通过修改`main.js`中的`DELETE_MSG_COUNT_PER_TIME`常量来变更。建议修改为你平均每秒接到的消息数量。
- 任何撤回的消息都会存入本地的数据库（位于LLQQNT的插件数据目录（`plugin_data`里），以便于重启后读取已撤回的消息记录。

所以，目前反撤回**重启QQ仍然生效**，但图片消息会恢复失败，请等待版本更新。

相关详细的原理和说明请参阅源码。

**使用LevelDB进行数据储存**，还没加入启用和关闭储存的开关，请等待后续版本更新（**如果你不想让插件储存撤回后的消息，你可以暂且不更新版本**）

## 总结

在NTQQ打开期间无论怎样操作，**反撤回均能生效**，消息会暂时保存在内存里，不会落盘，所以没有消息泄露风险。（如果你能读插件内存里的消息，你为什么不直接去读QQ的消息列表呢🤣）

NTQQ重启后，仅文本和表情可恢复，图片会恢复失败。

## 协议及免责

MIT | 禁止用于任何非法用途，插件开发属学习与研究目的，仅自用，未提供给任何第三方使用。任何不当使用导致的任何侵权问题责任自负。
