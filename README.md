# LiteLoaderQQNT - anti-recall

LiteLoaderQQNT插件，用于简易的防撤回。
使用前需要安装[LiteLoaderQQNT](https://github.com/mo-jinran/LiteLoaderQQNT)，并在QQNT新版上使用。

## 使用方法

clone或下载zip文件解压，保留文件夹结构（文件夹名称为`插件名`，内容为github上的内容），将文件夹移动至`LiteLoaderQQNT数据目录/plugins/`下面，重启QQNT即可。

所有被撤回的消息会被带上红框，文字加上删除线。重新进消息列表仍然可以看到。不过重启QQNT就会失效。

*注意：图片必须之前点开过，撤回后才能重新点开，否则会一直转圈，大概是因为原图未下载只有缩略图。*

## 原理介绍

**之前版本：**为什么在简介里说是简易的呢？因为这个防撤回原理是通过拦截撤回消息的IPC，这样消息就不会被删除。可是，若重新打开消息界面，NTQQ似乎会重新向逻辑层拉取一次消息（旧版QQ的防撤回直接从通信上就拦截了撤回包，所以没有这个问题；而本插件仅拦截到了渲染层的IPC，逻辑层还是一个黑盒），所以导致消息仍然被撤回了。

**现在版本的变更：**在接到消息后会将消息存于内存中，进入消息界面后，若发现撤回会拦截撤回包，并显示红色边框以及给文字附加删除线。若重新进入消息页面，会遍历消息列表，若发现撤回的提示，会寻找之前保存过的消息，若找到，则将撤回提示替换为之前保存的消息，并显示红色边框以及给文字附加删除线；若未找到，则仍然显示撤回提示。

- 为避免太占内存，保存消息的上限默认为1000条。如有需要，可自行修改`main.js`中的`MAX_MSG_SAVED_LIMIT`常量。这个值的意义是，假设默认最多存1000条，那么总接到消息的1000条之前的消息若被撤回则无法恢复。**不过，若一条消息在撤回后你回去看了，并且反撤回生效（也就是只要你看到了这条消息出现红框和删除线），则这条消息会被额外储存到专门的“已撤回消息数组”中，这个数组没有容量上限，不会被本限制所约束。**
- 为避免可能存在的并发问题，消息超过上述限制后，每次接到消息后默认会删除保存的消息列表中的前50条，直到低于上述上限。这个50条你也可以通过修改`main.js`中的`DELETE_MSG_COUNT_PER_TIME`常量来变更。建议修改为你平均每秒接到的消息数量。

所以，目前反撤回**仅在进程生命周期有效**（重启QQNT失效，消息会被重新撤回）。

相关详细的原理和说明请参阅源码。

## 总结

现在会将消息暂时保存在内存里，不会落盘，所以没有消息泄露风险。（如果你能读插件内存里的消息，你为什么不直接去读QQ的消息列表呢🤣）

如果有安全的序列化储存方式，那么撤回持久化也不是什么问题。

## 协议及免责

MIT | 禁止用于任何非法用途，插件开发属学习与研究目的，仅自用，未提供给任何第三方使用。任何不当使用导致的任何侵权问题责任自负。
